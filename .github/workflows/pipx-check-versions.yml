---
name: Pipx Check Versions

on:
  schedule:
    - cron: "0 0 * * 0"
  workflow_dispatch:

permissions: {}

defaults:
  run:
    working-directory: xml

jobs:
  npm-check-versions:
    runs-on: ubuntu-latest
    steps:
      - name: Check out
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
        with:
          fetch-depth: 1
          persist-credentials: false
      - name: Set up Python
        uses: actions/setup-python@83679a892e2d95755f2dac6acb0bfd1e9ac5d548 # v6.1.0
        with:
          python-version: 3.14
      - name: Check outdated dependencies
        shell: bash
        run: |
          set -euo pipefail
          IFS=$'\n\t'
          rc=0
          # Read each line from requirements.txt
          while IFS= read -r line; do
              # Skip empty lines and comments
              if [[ -z "$line" || "$line" =~ ^# ]]; then
                  continue
              fi
              # Extract package name and current version
              if [[ "$line" =~ ^([a-zA-Z0-9_-]+)==([0-9.]+) ]]; then
                  package="${BASH_REMATCH[1]}"
                  current_version="${BASH_REMATCH[2]}"
                  # Get latest version from PyPI using pip index versions
                  # The version in parentheses on the first line is the latest
                  latest_version="$(\pip index versions "${package}" 2>/dev/null | { \grep -e '^Available versions: ' || true; } | \cut -d ',' -f 1 | \sed -e 's/^.*: //')"
                  if [ "${current_version}" != "${latest_version}" ]; then
                      echo "${package}: ${current_version} -> ${latest_version}"
                      rc=$((rc+1))
                  fi
              fi
          done < requirements.txt
          exit ${rc}
